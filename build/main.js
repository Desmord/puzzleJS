"use strict";var _createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var TransitionManager=function(){function e(){_classCallCheck(this,e),this.level=3,this.startContainer=document.querySelector(".startSettingsContainer"),this.gameContainer=document.querySelector(".gameContainer"),this.gameBoard=document.querySelector(".gameBoard"),this.gameMenu=document.querySelector(".gameMenu"),this.orientation="landscape",this.menuManager=null,this.gameManager=null}return _createClass(e,[{key:"setGameManager",value:function(e){this.gameManager=e}},{key:"setMenuManager",value:function(e){this.menuManager=e}},{key:"setLevel",value:function(e){this.level=e}},{key:"setOrientation",value:function(){var r=this;return new Promise(function(e,t){window.innerWidth>window.innerHeight?r.orientation="landscape":r.orientation="portrait",e()})}},{key:"hideStartMenu",value:function(){var r=this;return new Promise(function(e,t){r.startContainer.classList.add("fadeOut"),setTimeout(function(){r.startContainer.style.display="none",r.startContainer.classList.remove("fadeOut")},490),e()})}},{key:"showStartMenu",value:function(){var r=this;return new Promise(function(e,t){setTimeout(function(){r.startContainer.style.display="block",r.startContainer.classList.add("fadeIn")},600),setTimeout(function(){r.startContainer.classList.remove("fadeIn")},1200),e()})}},{key:"setSize",value:function(e){this.gameBoard.style.width=e.boardWidth+"px",this.gameBoard.style.height=e.boardWidth+"px",e.marginRight?(this.gameBoard.style.marginRight=e.marginRight+"px",this.gameBoard.style.marginBottom="0px"):(this.gameBoard.style.marginBottom=e.marginBottom+"px",this.gameBoard.style.marginRight="0px"),this.gameMenu.style.width=e.menuWidth+"px",this.gameMenu.style.height=e.menuHeigth+"px"}},{key:"setElementsSize",value:function(){var d=this;return new Promise(function(e,t){var r=window.innerWidth,a=window.innerHeight;if("landscape"===d.orientation){var n=Number.parseInt(.55*r),i=Number.parseInt(.05*r),s=Number.parseInt(.25*r),o=Number.parseInt(.8*a);o=(n=Number.parseInt(.8*a)<n?Number.parseInt(.8*a):n)<o?n:o,d.setSize({boardWidth:n,marginRight:i,marginBottom:0,menuWidth:s,menuHeigth:o})}else{var l=Number.parseInt(.05*a),u=Number.parseInt(.55*a),h=Number.parseInt(.2*a),c=Number.parseInt(.8*r);u=u>Number.parseInt(.9*r)?Number.parseInt(.9*r):u,d.setSize({boardWidth:u,marginRight:0,marginBottom:l,menuWidth:c,menuHeigth:h})}e()})}},{key:"showGame",value:function(){var r=this;return new Promise(function(e,t){setTimeout(function(){r.gameContainer.style.display="flex",r.gameContainer.classList.add("fadeIn")},600),setTimeout(function(){r.gameContainer.classList.remove("fadeIn")},1200),e()})}},{key:"hideGame",value:function(){var r=this;return new Promise(function(e,t){r.gameContainer.classList.add("fadeOut"),setTimeout(function(){r.gameContainer.style.display="none",r.gameContainer.classList.remove("fadeOut")},490),e()})}},{key:"startGame",value:function(e){var t=this;this.setLevel(e),this.setOrientation().then(function(){return t.hideStartMenu()}).then(function(){return t.setElementsSize()}).then(function(){return t.showGame()}).then(function(){t.gameManager.setLevel(t.level),setTimeout(function(){t.gameManager.loadNewImage()},600)}).catch(function(e){console.log("bład")})}},{key:"endGame",value:function(){var e=this;this.hideGame().then(function(){return e.showStartMenu()})}}]),e}();_createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var GameManager=function(){function t(e){_classCallCheck(this,t),this.transitionManager=transitionManager,this.gameCellArray=[],this.gameCellWidth=0,this.level=3,this.resizeEvent=null,this.currentDragCell=null,this.gameBoard=document.querySelector(".gameBoard"),this.image=new Image,this.drag=this.drag.bind(this),this.endDrag=this.endDrag.bind(this),this.closeGame=this.closeGame.bind(this),this.resizeGameBoard=this.resizeGameBoard.bind(this),this.gameCellsMousedown=this.gameCellsMousedown.bind(this),this.checkIfStillGameBoard=this.checkIfStillGameBoard.bind(this)}return _createClass(t,[{key:"setLevel",value:function(e){this.level=e}},{key:"setGameCellWidth",value:function(e){this.gameCellWidth=e}},{key:"setCurrentDragCell",value:function(e){this.currentDragCell=e}},{key:"setDOMElementsEvents",value:function(){document.querySelector(".menuButtons").addEventListener("mouseover",this.hoverGameMenu),document.querySelector(".menuButtons").addEventListener("mouseleave",this.mouseLeaveGameMenu),document.querySelector("#endGame").addEventListener("click",this.closeGame),document.querySelector(".gameBoard").addEventListener("mousedown",this.gameCellsMousedown),window.addEventListener("resize",this.resizeGameBoard),this.image.addEventListener("load",this.loadGame.bind(this),!1)}},{key:"closeGame",value:function(){this.transitionManager.endGame()}},{key:"hoverGameMenu",value:function(e){var t=document.querySelector(".tooltip");"endGame"===e.target.id?(t.innerHTML=e.target.getAttribute("data-tooltip"),t.style.opacity="0.7"):"start"===e.target.id?(t.innerHTML=e.target.getAttribute("data-tooltip"),t.style.opacity="0.7"):"pause"===e.target.id&&(t.innerHTML=e.target.getAttribute("data-tooltip"),t.style.opacity="0.7")}},{key:"mouseLeaveGameMenu",value:function(){document.querySelector(".tooltip").style.opacity="0"}},{key:"resizeGameBoard",value:function(){var e=this;clearTimeout(this.resizeEvent),this.resizeEvent=setTimeout(function(){e.transitionManager.setElementsSize().then(function(){return e.removeBoard()}).then(function(){return e.createEmptyBoard()}).then(function(){return e.updateGameCellArray()}).then(function(){return e.drawCells()}).catch(function(e){console.log(e)})},200)}},{key:"gameCellsMousedown",value:function(e){this.setCurrentDragCell(e.target),document.addEventListener("mouseup",this.endDrag),document.addEventListener("mousemove",this.drag)}},{key:"endDrag",value:function(e){this.dropCell(e),document.removeEventListener("mouseup",this.endDrag),document.removeEventListener("mousemove",this.drag)}},{key:"drag",value:function(e){this.checkIfStillGameBoard(e)&&e.target.parentNode.classList.contains("gameCell")&&(e.target.parentNode.style.webkitTransform="translate("+(-1*(e.target.parentNode.offsetLeft-e.clientX)-e.target.width/2)+"px\n                                                            ,"+(-1*(e.target.parentNode.offsetTop-e.clientY)-e.target.height/2)+"px)")}},{key:"checkIfStillGameBoard",value:function(e){return!(e.clientX<this.gameBoard.offsetLeft||e.clientX>this.gameBoard.offsetLeft+this.gameBoard.clientWidth||e.clientY<this.gameBoard.offsetTop||e.clientY>this.gameBoard.offsetTop+this.gameBoard.clientHeight)}},{key:"dropCell",value:function(e){var t=this;if(this.checkIfStillGameBoard(e)){for(var r=this.currentDragCell,a=null,n=[].concat(_toConsumableArray(document.querySelectorAll(".gameCell"))),i=0;i<n.length;i++)e.clientX>n[i].offsetLeft&&e.clientX<n[i].offsetLeft+this.gameCellWidth&&e.clientY>n[i].offsetTop&&e.clientY<n[i].offsetTop+this.gameCellWidth&&(a=n[i].children[0]);if(a==r)this.removeBoard().then(function(){return t.createEmptyBoard()}).then(function(){return t.drawCells()}).catch(function(e){console.log(e)});else{for(var s=null,o=0,l=null,u=0,h=0;h<this.gameCellArray.length;h++)this.gameCellArray[h].img==r?(s=this.gameCellArray[h],o=h):this.gameCellArray[h].img==a&&(l=this.gameCellArray[h],u=h);this.gameCellArray[o]=l,this.gameCellArray[u]=s,this.removeBoard().then(function(){return t.createEmptyBoard()}).then(function(){return t.drawCells()}).catch(function(e){console.log(e)})}}else console.log("Kamorka gry poza planszą.")}},{key:"loadGame",value:function(){var e=this;this.clearGameArray().then(function(){return e.removeBoard()}).then(function(){return e.createEmptyBoard()}).then(function(){return e.createGameCellArray()}).then(function(){return e.shuffleCellsArray()}).then(function(){return e.drawCells()}).catch(function(e){console.log(e)})}},{key:"clearGameArray",value:function(){var r=this;return new Promise(function(e,t){r.gameCellArray=[],e()})}},{key:"removeBoard",value:function(){var r=this;return new Promise(function(e,t){for(;r.gameBoard.firstChild;)r.gameBoard.removeChild(r.gameBoard.firstChild);e()})}},{key:"loadNewImage",value:function(){this.removeBoard(),this.image.src="https://source.unsplash.com/random/"+this.gameBoard.clientWidth+"x"+this.gameBoard.clientWidth+"#"+(new Date).getTime()}},{key:"createEmptyBoard",value:function(){var i=this;return new Promise(function(e,t){i.setGameCellWidth(Number.parseInt((i.gameBoard.clientWidth-10)/3));for(var r=0;r<i.level;r++)for(var a=0;a<i.level;a++){var n=document.createElement("div");n.style.width=i.gameCellWidth+"px",n.style.height=i.gameCellWidth+"px",n.style.marginLeft="2px",n.style.marginTop="2px",n.classList.add("gameCell"),i.gameBoard.appendChild(n)}e()})}},{key:"createGameCellArray",value:function(){var h=this;return new Promise(function(e,t){for(var r=[].concat(_toConsumableArray(document.querySelectorAll(".gameCell"))),a=r[0].parentNode.offsetLeft,n=r[0].parentNode.offsetTop,i=0,s=0;s<h.level;s++)for(var o=0;o<h.level;o++){var l=r[i].offsetLeft-a,u=r[i].offsetTop-n;h.gameCellArray.push({order:i,img:h.getImagePortion(h.image,h.gameCellWidth,l,u)}),i++}e()})}},{key:"updateGameCellArray",value:function(){var v=this;return new Promise(function(e,t){for(var r=[].concat(_toConsumableArray(document.querySelectorAll(".gameCell"))),a=r[0].parentNode.offsetLeft,n=r[0].parentNode.offsetTop,i=[],s=0;s<v.gameCellArray.length;s++)i.push(v.gameCellArray[s].order);for(var o=0;o<v.gameCellArray.length;o++)for(var l=v.gameCellArray[o],u=0;u<v.gameCellArray.length;u++)v.gameCellArray[u].order===o&&(v.gameCellArray[o]=v.gameCellArray[u],v.gameCellArray[u]=l);for(var h=0;h<v.gameCellArray.length;h++){var c=r[h].offsetLeft-a,d=r[h].offsetTop-n;v.gameCellArray[h].x=r[h].offsetLeft,v.gameCellArray[h].maxX=r[h].offsetLeft+v.gameCellWidth,v.gameCellArray[h].y=r[h].offsetTop,v.gameCellArray[h].maxY=r[h].offsetTop+v.gameCellWidth,v.gameCellArray[h].img=v.getImagePortion(v.image,v.gameCellWidth,c,d)}for(var m=0;m<v.gameCellArray.length;m++)if(!v.gameCellArray[m].order==i[m]);else for(var g=v.gameCellArray[m],f=0;f<v.gameCellArray.length;f++)v.gameCellArray[f].order==i[m]&&(v.gameCellArray[m]=v.gameCellArray[f],v.gameCellArray[f]=g);e()})}},{key:"getImagePortion",value:function(e,t,r,a){var n=document.createElement("canvas"),i=n.getContext("2d");n.width=t,n.height=t;var s=document.createElement("canvas"),o=s.getContext("2d");return s.width=this.gameBoard.clientWidth,s.height=this.gameBoard.clientWidth,o.drawImage(e,0,0,this.gameBoard.clientWidth,this.gameBoard.clientWidth),i.drawImage(s,r,a,t,t,0,0,t,t),n}},{key:"shuffleCellsArray",value:function(){var i=this;return new Promise(function(e,t){for(var r=i.gameCellArray.length;0<r;){var a=Math.floor(Math.random()*r);r--;var n=i.gameCellArray[r];i.gameCellArray[r]=i.gameCellArray[a],i.gameCellArray[a]=n}e()})}},{key:"drawCells",value:function(){var n=this;return new Promise(function(e,t){for(var r=[].concat(_toConsumableArray(document.querySelectorAll(".gameCell"))),a=0;a<n.gameCellArray.length;a++)r[a].appendChild(n.gameCellArray[a].img);e()})}}]),t}();_createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var SquaresAnimationManager=function(){function t(e){_classCallCheck(this,t),this.width=e.clientWidth,this.height=e.clientHeight,this.container=e,this.container.width=this.width,this.container.height=this.height,this.squares=[],this.squaresNumber=0,this.containerGraphicContext=this.container.getContext("2d"),this.draw=this.draw.bind(this),this.colors=[[246,114,128],[192,108,132],[53,92,125],[69,173,168],[153,184,152],[255,255,255],[253,253,150]]}return _createClass(t,[{key:"setWidth",value:function(e){this.width=e}},{key:"setHeight",value:function(e){this.height=e}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"drawTheColor",value:function(){return this.colors[Math.floor(7*Math.random())]}},{key:"createSquare",value:function(){var e={actualAngle:1,velocity:1*Math.random()+.01,rotationSpeed:Number.parseFloat(.01*Math.random()).toFixed(3),width:Number.parseInt(80*Math.random()),x:Math.random()*this.getWidth()+1,y:this.getHeight(),opacity:.2*Math.random(),color:this.drawTheColor()};return 0==Number.parseFloat(e.rotationSpeed)&&(e.rotationSpeed=Number.parseFloat(.01)),e}},{key:"fillSquaresArray",value:function(){var e=[];this.squaresNumber=Number.parseInt(this.getWidth()/100),this.squaresNumber<4&&(this.squaresNumber=4);for(var t=0;t<this.squaresNumber;t++)e[t]=this.createSquare();this.squares=e}},{key:"clearElement",value:function(){this.containerGraphicContext.clearRect(0,0,this.getWidth(),this.getHeight()),this.containerGraphicContext.beginPath()}},{key:"updateSquaresPosition",value:function(){this.squares=this.squares.map(function(e){return e.y-=e.velocity,e})}},{key:"updateSquaresRotationAngle",value:function(){this.squares=this.squares.map(function(e){return 359<=Number.parseFloat(e.actualAngle)?e.actualAngle=1:e.actualAngle=Number.parseFloat(e.actualAngle)+Number.parseFloat(e.rotationSpeed),e})}},{key:"updateSquaresNumber",value:function(){for(var e=this.squares.filter(function(e){return 1<e.y+2*e.width}),t=this.squaresNumber-e.length,r=0;r<t;r++)e.push(this.createSquare());this.squares=e}},{key:"drawSquares",value:function(){for(var e=0;e<this.squares.length;e++)this.containerGraphicContext.save(),this.containerGraphicContext.beginPath(),this.containerGraphicContext.translate(this.squares[e].x+this.squares[e].width,this.squares[e].y+this.squares[e].width),this.containerGraphicContext.rotate(this.squares[e].actualAngle+Math.PI/180),this.containerGraphicContext.translate(-1*this.squares[e].width,-1*this.squares[e].width),this.containerGraphicContext.rect(this.squares[e].width/2,this.squares[e].width/2,this.squares[e].width,this.squares[e].width),this.containerGraphicContext.fillStyle="rgba("+this.squares[e].color[0]+","+this.squares[e].color[1]+","+this.squares[e].color[2]+","+this.squares[e].opacity+")",this.containerGraphicContext.fill(),this.containerGraphicContext.restore()}},{key:"draw",value:function(){this.clearElement(),this.drawSquares(),this.updateSquaresPosition(),this.updateSquaresRotationAngle(),this.updateSquaresNumber(),window.requestAnimationFrame(this.draw)}},{key:"setResizeEvent",value:function(){var e=this,t=void 0;window.addEventListener("resize",function(){clearTimeout(t),t=setTimeout(function(){e.clearElement(),e.setHeight(e.container.clientHeight),e.setWidth(e.container.clientWidth),e.container.width=e.width,e.container.height=e.height,e.fillSquaresArray()},200)})}},{key:"startAnimation",value:function(){this.fillSquaresArray(),this.setResizeEvent(),window.requestAnimationFrame(this.draw)}}]),t}();_createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var StartMenuManager=function(){function t(e){_classCallCheck(this,t),this.transitionManager=e,this.sliderContainer=document.querySelector(".sliderContainer"),this.startButton=document.querySelector("#startButton"),this.sliderThumb=document.querySelector(".sliderThumb"),this.sliderThumbX=this.sliderThumb.getBoundingClientRect().x,this.sliderTrack=document.querySelector(".sliderTrack"),this.sliderShiftedTrack=document.querySelector(".sliderShiftedTrack"),this.label=document.querySelector(".startSettingsContainer :nth-child(3)"),this.level=3,this.endThumbDrag=this.endThumbDrag.bind(this),this.thumbDrag=this.thumbDrag.bind(this),this.resetSliderAndLevel=this.resetSliderAndLevel.bind(this)}return _createClass(t,[{key:"setLevel",value:function(e){this.level=e}},{key:"getLevel",value:function(){return this.level}},{key:"setLabelText",value:function(e){this.label.innerHTML="Poziom: &nbsp; "+e}},{key:"resetSliderTransformations",value:function(){this.sliderThumb.style.webkitTransform="translate(0px,0)"}},{key:"resetTrackSliderWidth",value:function(){this.sliderShiftedTrack.style.width="30%"}},{key:"resetLevel",value:function(){this.setLevel(3),this.setLabelText(3)}},{key:"resetSliderAndLevel",value:function(){this.sliderThumbX=this.sliderThumb.getBoundingClientRect().x,this.resetSliderTransformations(),this.resetTrackSliderWidth(),this.resetLevel()}},{key:"calculateLevel",value:function(){var e=this.sliderTrack.getBoundingClientRect().width,t=this.sliderThumb.getBoundingClientRect().x-this.sliderTrack.getBoundingClientRect().x,r=Number.parseInt(t/(e/10)+1);return r<=0?1:11<=r?10:r}},{key:"thumbDrag",value:function(e){e.clientX>this.sliderTrack.getBoundingClientRect().x&&e.clientX<this.sliderTrack.getBoundingClientRect().right?(this.sliderThumb.style.webkitTransform="translate("+-1*(this.sliderThumbX-e.clientX)+"px,0)",this.sliderShiftedTrack.style.width=-1*(this.sliderTrack.getBoundingClientRect().x-e.clientX)+"px",this.setLevel(this.calculateLevel())):this.sliderThumb.getBoundingClientRect().x<this.sliderTrack.getBoundingClientRect().x||e.clientX<this.sliderTrack.getBoundingClientRect().x?(this.sliderThumb.style.webkitTransform="translate("+-1*(this.sliderThumbX-this.sliderTrack.getBoundingClientRect().x)+"px,0)",this.setLevel(1)):(this.sliderThumb.getBoundingClientRect().x>this.sliderTrack.getBoundingClientRect().x+this.sliderTrack.getBoundingClientRect().width||e.clientX>this.sliderTrack.getBoundingClientRect().x+this.sliderTrack.getBoundingClientRect().width)&&(this.sliderThumb.style.webkitTransform="translate("+(this.sliderTrack.getBoundingClientRect().right-this.sliderThumbX)+"px,0)",this.setLevel(10)),this.setLabelText(this.getLevel())}},{key:"endThumbDrag",value:function(){document.removeEventListener("mouseup",this.endThumbDrag),document.removeEventListener("mousemove",this.thumbDrag)}},{key:"sliderThumbDragEvent",value:function(){var t=this;this.sliderThumb.addEventListener("mousedown",function(e){document.addEventListener("mouseup",t.endThumbDrag),document.addEventListener("mousemove",t.thumbDrag)})}},{key:"startButtonEvent",value:function(){var e=this;this.startButton.addEventListener("click",function(){e.transitionManager.startGame(e.getLevel())})}},{key:"resizeWindowEvent",value:function(){window.addEventListener("resize",this.resetSliderAndLevel)}},{key:"sliderTrackClickEvent",value:function(){this.sliderContainer.addEventListener("click",this.thumbDrag)}},{key:"setEvents",value:function(){this.startButtonEvent(),this.sliderTrackClickEvent(),this.sliderThumbDragEvent(),this.resizeWindowEvent()}}]),t}(),backGroundAnimation=new SquaresAnimationManager(document.querySelector(".backgorundCanvas")),transitionManager=new TransitionManager,startMenuManager=new StartMenuManager(transitionManager),gameManager=new GameManager(transitionManager),init=function(){backGroundAnimation.startAnimation(),startMenuManager.setEvents(),gameManager.setDOMElementsEvents(),transitionManager.setGameManager(gameManager),transitionManager.setMenuManager(startMenuManager)};init();